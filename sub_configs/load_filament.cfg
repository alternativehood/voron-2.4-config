[gcode_macro PURGE_POSITION]
description: Move toolhead to purge position
# Usage:
#   PURGE_POSITION
gcode:
    PARK_NOZZLE
    G1 X141 Y350 F6000

[gcode_macro LOAD_FILAMENT]
description: Load and purge filament based on material (PLA / PETG / ABS)
# Usage:
#   LOAD_FILAMENT NEW=pla OLD=petg
#   LOAD_FILAMENT NEW=petg OLD=abs PURGE_POSITION_X=150 PURGE_POSITION_Y=340
gcode:
    SAVE_GCODE_STATE NAME=LOAD_FILAMENT_STATE

    # --- Params & defaults ---
    {% set purge_x = params.PURGE_POSITION_X|default(141)|float %}
    {% set purge_y = params.PURGE_POSITION_Y|default(350)|float %}
    {% set material = params.NEW|default("pla")|lower %}
    {% set previous_material = params.OLD|default("pla")|lower %}
    {% set purge_len = params.PURGE_LEN|default(60)|float %}

    # --- Choose nozzle temperature by material ---
    {% if previous_material == "pla" %}
        {% set target_temp = 210 %}
    {% elif previous_material == "petg" %}
        {% set target_temp = 240 %}
    {% elif previous_material == "abs" %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.5
        {% set target_temp = 265 %}
    {% else %}
        # Fallback if unknown material is passed
        {% set target_temp = 220 %}
    {% endif %}

    PURGE_POSITION

    # --- Heat to target temperature and wait ---
    M109 S{target_temp}

    # --- Purge 120mm ---
    # NOTE: ensure max_extrude_only_distance >= 120 in [extruder] or lower purge_len.
    M83                         ; relative extrusion
    G1 E{purge_len} F300        ; purge 120mm at modest speed
    # --- Choose nozzle temperature by material ---
    {% if material == "pla" %}
        {% set target_temp = 210 %}
    {% elif material == "petg" %}
        {% set target_temp = 240 %}
    {% elif material == "abs" %}
        SET_FAN_SPEED FAN=exhaust_fan SPEED=0.5
        {% set target_temp = 265 %}
    {% else %}
        # Fallback if unknown material is passed
        {% set target_temp = 220 %}
    {% endif %}
    # --- Heat to target temperature and wait ---
    M109 S{target_temp}
    G1 E{purge_len} F300        ; purge 120mm at modest speed

    # --- Clean nozzle & park again ---
    CLEAN_NOZZLE
    PARK_NOZZLE
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0.0
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_STATE